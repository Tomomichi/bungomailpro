%h1 コース作成

= form_for @course, html: {class: 'ui form'} do |f|
  .required.field
    = f.label :title, 'タイトル'
    = f.text_field :title
  .field
    = f.label :description, '説明'
    = f.text_area :description, rows: '3'

  %h3.ui.small.header 本の追加
  .ui.secondary.padded.segment
    .ui.action.fluid.input
      %input(type="text" placeholder="青空文庫の図書カードURLを入力" onchange="setURL(this.value)")
      = link_to '/books/scrape/?url=', id: 'searchButton', class: 'ui primary button', method: :post, remote: true do
        %i.add.icon
        追加

  .ui.divider

  #bookList.ui.middle.alligned.divided.relaxed.large.list
    #loader.ui.disabled.text.loader Loading..

  .ui.bottom.fixed.borderless.menu
    .item
      %button.ui.basic.button(type="submit" value="draft") 下書き保存
    .item
      %button.ui.primary.button(type="submit" value="public") 公開



:javascript
  /***********************************************
  * Functions
  ***********************************************/
  function setURL(url) {
    var baseHref = '/books/scrape/?url=';
    document.getElementById('searchButton').setAttribute('href', baseHref + url);
  }

  function addBook(data) {
    var item = document.createElement('div');
    item.setAttribute('id', data['aozora_id']);
    item.setAttribute('class', 'item');
    item.innerHTML = `
      <div class="right floated content">
        <div class="ui icon basic button" onclick="removeBook(${ data['aozora_id'] })">
          <i class="icon remove"></i>
        </div>
      </div>
      <i class="icon content"></i>
      <div class="content">
        <div class="header">
          ${ data['author'] }『${ data['title'] }』
          <small><a href="#" target="_blank"><i class="icon external"></i></a></small>
        </div>
        <div class="description">
          <small>文字数：約12,000字</small>
        </div>
      </div>
    `;
    document.getElementById('bookList').appendChild(item);
  }

  function removeBook(aozora_id) {
    var element = document.getElementById(aozora_id);
    element.parentNode.removeChild(element);
  }


  /***********************************************
  * Events
  ***********************************************/
  document.body.addEventListener('ajax:before', function() {
    document.getElementById('loader').classList.replace('disabled', 'active');
  })

  document.body.addEventListener('ajax:success', function(event) {
    document.getElementById('loader').classList.replace('active', 'disabled');

    var detail = event.detail;
    var data = detail[0], status = detail[1],  xhr = detail[2];

    if(!data) {
      alert('データの追加に失敗しました(´；ω；｀) URLを再度ご確認いただき、それでも追加できない場合は運営までお問い合わせください。')
      return false;
    }

    if(document.getElementById(data['aozora_id'])) {
      alert('その本はもうリストに追加されているようです。他の本をお試しください。')
    }else {
      addBook(data);
    }
  })
